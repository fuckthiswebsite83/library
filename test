local ESP = {}
ESP.__index = ESP

local RunService = game:GetService("RunService")

local Box = {}
Box.__index = Box

function Box.new()
    local self = setmetatable({}, Box)
    self.box = Drawing.new("Square")
    self.box.Visible = false
    self.box.Color = Color3.new(1, 0, 0)
    self.box.Thickness = 2
    self.box.Transparency = 1

    self.healthBar = Drawing.new("Square")
    self.healthBar.Visible = false
    self.healthBar.Color = Color3.new(0, 1, 0)
    self.healthBar.Thickness = 1
    self.healthBar.Transparency = 1
    self.healthBar.Filled = true

    return self
end

function Box:Update(character)
    local head = character:FindFirstChild("Head")
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    
    if not (head and rootPart and humanoid) then
        self.box.Visible = false
        self.healthBar.Visible = false
        return
    end

    local camera = workspace.CurrentCamera
    
    local cornerPoints = {
        rootPart.Position + Vector3.new(2, 3, 2),  -- Top Right Front
        rootPart.Position + Vector3.new(-2, 3, 2),  -- Top Left Front
        rootPart.Position + Vector3.new(-2, -3, 2),  -- Bottom Left Front
        rootPart.Position + Vector3.new(2, -3, 2),  -- Bottom Right Front
        rootPart.Position + Vector3.new(2, 3, -2),  -- Top Right Back
        rootPart.Position + Vector3.new(-2, 3, -2),  -- Top Left Back
        rootPart.Position + Vector3.new(-2, -3, -2),  -- Bottom Left Back
        rootPart.Position + Vector3.new(2, -3, -2),  -- Bottom Right Back
    }
    
    local screenPoints = {}
    local onScreen = true
    local minX, minY = math.huge, math.huge
    local maxX, maxY = -math.huge, -math.huge
    
    for _, point in ipairs(cornerPoints) do
        local screenPoint, visible = camera:WorldToViewportPoint(point)
        if not visible then
            onScreen = false
            break
        end
        
        minX = math.min(minX, screenPoint.X)
        minY = math.min(minY, screenPoint.Y)
        maxX = math.max(maxX, screenPoint.X)
        maxY = math.max(maxY, screenPoint.Y)
    end
    
    if onScreen then
        local boxWidth = maxX - minX
        local boxHeight = maxY - minY

        self.box.Size = Vector2.new(boxWidth, boxHeight)
        self.box.Position = Vector2.new(minX, minY)
        self.box.Visible = true
        
        local healthPercent = humanoid.Health / humanoid.MaxHealth
        self.healthBar.Size = Vector2.new(5, boxHeight * healthPercent)
        self.healthBar.Position = Vector2.new(minX - 10, minY + boxHeight * (1 - healthPercent))
        self.healthBar.Visible = true
    else
        self.box.Visible = false
        self.healthBar.Visible = false
    end
end

function Box:SetVisible(visible)
    self.box.Visible = visible
    self.healthBar.Visible = visible
end

ESP.Box = Box

return ESP
